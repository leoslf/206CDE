<!DOCTYPE html>
<!--
vim: ft=htmldjango
-->
{% set subtotals = [] %}

{% macro bill_table(old, new, month_description) %}
    {% set old_reading = old['absolute_reading'] | default(0, true) %}
    {% set new_reading = new['absolute_reading'] %}
    {% set consumption_unit = new_reading - old_reading %}
    {% set consumption_MJ = consumption_unit * 48 %}
    {% set gas_charges = query("dual", "monthly_charge('%s', %d) AS charge" | format(new['period_start']|dateformat, consumption_unit)) %}
    {% set fuel_cost = (consumption_MJ * 0.019) | round(2) %}
    {% set maintenance_charge = 9.5 %}
    <table class="billing-table">
        <tbody>
            <tr>
                <td class="topleft">From {{ old['period_start']|dateformat }}</td>
                <td class="top bottom" rowspan="2">to</td>
                <td class="top">{{ new['period_start']|dateformat }}</td>
                <td class="topleft bottomright">1 unit = 48MJ</td>
                <td class="topright">Comsumption(MJ)</td>
                <td rowspan="6">{{ month_description }}</td>
            </tr>
            <tr>
                <td class="bottomleft">{{ old_reading }} Estimate</td>
                <td class="bottom">{{ new_reading }} Estimate</td>
                <td class="bottomleft bottomright">{{ consumption_unit }} units x 48</td>
                <td class="bottomright">{{ consumption_MJ }}</td>
            </tr>
            <tr>
                <td colspan="4">
                    Standard gas charge
                </td>
                <td>
                    {% if gas_charges and gas_charges | length > 0 %}
                        {% set gas_charge = gas_charges[0]['charge'] | round(2) %}
                        {{ "%.02f" | format(gas_charge) }}
                    {% else %}
                        Failed to query gas_charge
                        
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td colspan="4">
                    Fuel cost adjustment(1.900 cents pert MJ)
                </td>
                <td>
                    {{ "%.02f" | format(fuel_cost) }}
                </td>
            </tr>
            <tr>
                <td colspan="4">
                    Monthly maintenance charge
                </td>
                <td>
                    {{ "%.02f" | format(maintenance_charge) }}
                </td>
            </tr>
            {% set subtotal = (gas_charge + fuel_cost + maintenance_charge) | round(2) %}
            <tr class="billing-table-end">
                <td colspan="4">
                </td>
                <td>
                    {{ "%.02f" | format(subtotal) }}
                </td>
            </tr>
        </tbody>
    </table>
    {% do subtotals.append(subtotal) %}
{% endmacro %}

{% macro bill_consumption(account_id, month) %}
    {% set consumptions = query("Consumption_view", condition="account_id = %d AND period_start < TO_DATE('%s')" | format(account_id | default(-1, true) | int, month), limit=3) %}
    {% if consumptions %}
        <script>
        {% for consumption in consumptions|reverse %}
                console.log("{{ consumption['period_start'] | dateformat }}: {{ consumption['absolute_reading'] }}");
        {% endfor %}
        </script>
        {{ bill_table(consumptions[2], consumptions[1], "Last Month") }}
        <br><br>
        {{ bill_table(consumptions[1], consumptions[0], "This Month") }}
    {% endif %}
{% endmacro %}
            



{% set title = "Bill " + (request.args.get('account_id') if 'account_id' in request.args else "AccountNumberMissing") %}
<html>
<head>
    {% include 'head.html' %}
    <link rel="stylesheet" type="text/css" href="page.css" />
    <link rel="stylesheet" type="text/css" href="bill.css" />
</head>
<body>
{% if g.authentication() or is_bill_visible(request.args) %}
    {% set bill = query_bill(request.args) %}
    {% if bill or g.authentication() %}
        {% if bill and bill | length > 0 %}
            {% set bill = bill[0] %}
            {% if g.authentication() %}
            <script>
                {% for attr in bill %}
                    console.log("{{ attr }}: {{ bill[attr] }}");
                {% endfor %}
            </script>
            {% endif %}
            {% set bill_date = request.args.get('date') | default('01-Dec-17', true)  %}
            <page size="A4">
                <div class="invoice-box">
                    <table>
                        <tbody>
                            <tr>
                                <td><img class="icon" src="https://www.cdf.gov.hk/tc/activities/images/towngas.jpg" /></td>
                            </tr>
                            <tr class="personal-information">
                                <td>
                                    {{ bill['customer_name'] }}<br />
                                    {% for attr in bill %}
                                        {% if str(attr).startswith("address_line") %}
                                            {{ bill[attr] }}<br />
                                        {% endif %}
                                    {% endfor %}
                                </td>
                                <td>
                                    Account Number: {{ account_number_format(request.args.get('account_id') | default(0, true))  }}<br />
                                    Created Date: {{ bill_date }}<br />
                                </td>
                            </tr>
                            <tr class="alert alert-info" role="info">
                                <td>
                                    Bill Information
                                </td>
                                <td width="50%">
                                    Billing date: 10 JAN 2018
                                </td>
                            </tr>
                            <tr class="billing">
                                <td colspan="6">
                                    <table>
                                        <tr>
                                            <td>
                                                {{ bill_consumption(request.args.get('account_id') | default(-1, true), bill_date) }}
                                                <br><br>
                                                <table class="billing-table" border="0">
                                                    <tr>
                                                        <td colspan="2"></td>
                                                        <td rowspan="6"></td>
                                                    </tr>
                                                    <tr>
                                                        <td colspan="2"></td>
                                                    </tr>
                                                    <!--
                                                    <tr>
                                                        <td>
                                                            Spare parts S123456
                                                        </td>
                                                        <td>
                                                            45.00
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td>
                                                            Hotplate Instalment(1st of 12)
                                                        </td>
                                                        <td>
                                                            83
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td>
                                                            Other Charge
                                                        </td>
                                                        <td>
                                                            128
                                                        </td>
                                                    </tr>
                                                    -->
                                                    <tr>
                                                        <td>Total bill amount
                                                        </td>
                                                        <td>
                                                            {{ "%.02f" | format(subtotals | sum) }}
                                                        </td>
                                                    </tr>
                                                </table>
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            <tr class="alert alert-info" role="info">
                                <td colspan="6">
                                    Self-reading by QR Code - Simple, Easy &amp; Quick: A new Self-reading method has been launched. SImply scan your gas bill's QR code, your account number will be displayed automatically. Entire the meter reading and submit.
                                </td>
                            </tr>
                            <tr class="empty-row">
                                <td></td>
                            </tr>
                            <tr class="bottom-information">
                                <td colspan="3">
                                    <table>
                                        <tbody>
                                            <tr rowspan="2">
                                                <td>
                                                    <img class="r90" src="https://cdn.pixabay.com/photo/2014/04/02/16/19/barcode-306926_960_720.png" height="50">
                                                </td>
                                                <td colspan="2">
                                                    Please pay this bill by {{ bill_date | datemath(months=+1) }}, ${{ subtotals | sum | round(0) }}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td rowspan="2"> <img src="https://www.myuberworks.com/media/wysiwyg/technology/icons_exp_01.png" height="75"></td>
                                                <td class="text-center">
                                                    Account number
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    {% if 'account_id' in request.args %}
                                                        <img class="center-block" src="/code39/{{ "%010d" | format(request.args.get('account_id') | int) }}" height="40px" />
                                                    {% else %}
                                                        <!--
                                                        <div class="alert alert-danger text-center" role="alert">
                                                            Missing account_id in request.args
                                                        </div>
                                                        -->
                                                        <!-- <img class="center-block" src="/code39/AccountNumberMissing?write_text=True" height="40px"/> -->
                                                        <img class="center-block" src="/code39/AccountNumberMissing" height="40px"/><br />
                                                        <div class="text-center">
                                                            AccountNumberMissing
                                                        </div>

                                                    {% endif %}
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>

                                    <div class="alert alert-info text-center" role="info">
                                        BANNER
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </page>
        {% endif %}
    {% else %}
        failed to query bill and not authenticated
    {% endif %}
{% endif %}
</body>

</html>
